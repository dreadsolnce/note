### УРОК 7

 ***Задание 19***
[ссылка на задание](https://lab.karpov.courses/learning/152/module/1762/lesson/17928/53213/353799/)

Посчитайте возраст каждого пользователя в таблице `users`.

Возраст измерьте числом полных лет, как мы делали [в прошлых уроках](https://lab.karpov.courses/learning/152/module/1762/lesson/17927/54325/256089/). Возраст считайте относительно последней даты в таблице `user_actions`.

Для тех пользователей, у которых в таблице `users` не указана дата рождения, укажите среднее значение возраста всех остальных пользователей, округлённое до целого числа.

Колонку с возрастом назовите `age`. В результат включите колонки с id пользователя и возрастом. Отсортируйте полученный результат по возрастанию id пользователя.

Поля в результирующей таблице: `user_id`, `age`

---

**Пояснение:**

В этой задаче вам придётся написать несколько подзапросов и, возможно, использовать табличные выражения. Пригодятся функции `DATE_PART`, `AGE` и `COALESCE`.

Функцию `COALESCE` мы рассматривали [в первых уроках](https://lab.karpov.courses/learning/152/module/1762/lesson/18484/53190/250926/).

Основная сложность заключается в заполнении пропусков средним значением — подумайте, как это можно сделать, и постройте запрос вокруг своего подхода.

**Решение:**
```
with users_age as (SELECT user_id,
                          date_part('year', age((SELECT max(time)
                                          FROM   user_actions), birth_date)) as age
                   FROM   users)
SELECT user_id,
       coalesce(age, (SELECT round(avg(age)) FROM   users_age))::integer as age
FROM   users_age
ORDER BY user_id
```

***Задание 20***
[ссылка на задание](https://lab.karpov.courses/learning/152/module/1762/lesson/17928/53213/353800/)