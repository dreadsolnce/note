##### Описание:
**Keepalived** — программный инструмент, предназначенный для обеспечения высокой доступности и отказоустойчивости сетевых сервисов. Он первоначально был разработан для работы с Linux Virtual Server (LVS) для балансировки нагрузки, но его функциональность была расширена, и теперь его часто используют для управления Virtual IP (VIP) адресами и для организации механизма failover (переключение на резервный сервер при сбое основного).
Keepalived работает на основе протокола VRRP (Virtual Router Redundancy Protocol), который позволяет нескольким серверам обмениваться информацией о состоянии друг друга.
В случае отказа одного из серверов, другой сервер может автоматически взять на себя его функции, чтобы пользователи не заметили прерывания в работе сервиса

##### Первый сервер:
vi /etc/keepalived/keepalived.conf
```
global_defs {  
    enable_script_security 
    router_id MASTER 
}  
  
vrrp_script nginx_check {  
    script "/usr/bin/curl http://127.0.0.1"  
    interval 5  
    user nginx  
}  
  
vrrp_instance web {  
    state MASTER  
    interface eth0  
    virtual_router_id 254  
    priority 100  
    advert_int 2  
    authentication {  
        auth_type PASS  
        auth_pass 12345678  
    }  
    virtual_ipaddress {  
        192.168.0.254  
    }  
    track_script {  
        nginx_check  
    }  
}
```
##### Второй сервер:
```
global_defs {  
    enable_script_security  
    router_id BACKUP
}  
  
vrrp_script nginx_check {  
    script "/usr/bin/curl http://127.0.0.1"  
    interval 5  
    user nginx  
}  
  
vrrp_instance web {  
    state BACKUP  
    interface eth0  
    virtual_router_id 254  
    priority 50  
    advert_int 2  
    preempt_delay 30  
    authentication {  
        auth_type PASS  
        auth_pass 12345678  
    }  
    virtual_ipaddress {  
        192.168.0.254  
    }  
    track_script {  
        nginx_check  
    }  
}
```

##### Описание параметров

> [!NOTE] Глобальные параметры
> - **global_defs —** задает глобальные настройки. В нашем примере мы разрешаем использование скриптов. В противном случае, keepalived будет возвращать ошибки при использовании скриптов проверки состояния и запуска **notify** (о нем ниже).
> - **vrrp_script —** описание процесса проверки сервиса. Мы не ограничены в способах — shell-скрипт должен вернуть 0, если все хорошо или другой код ответа, если все плохо. В данном примере мы отправляем запрос на 80 порт, на котором слушает веб-сервер. Если он работает, то команда вернет правильный код ответа. Однако, nginx может слушать на другом порту и это нужно учитывать. Также есть и другие варианты проверки работы nginx, например, команды **killall -0 nginx** и **pidof nginx**. Опция **interval** указывает на периодичность проверки в секундах; опция **user** задает пользователя. от которого будет выполняться скрипт.
> - **vrrp_instance —** настройки для экземпляра сервиса. В нашем примере мы дали название экземпляру web. Вы можете задать свое.Contents


> [!NOTE] GLOBAL_DEFS
> - enable_script_security - разрешаем использование скриптов.
> - router_id - уникальный идентификатор для данного роутера


> [!NOTE] VRRP_INSTANCE
> - **state —** задает начальное состояние ноды. В нашем случае первая **MASTER**, вторая **BACKUP**. Важно отметить, что если в конфигурации будет опция **nopreempt**, возможен только вариант **BACKUP**.
> - **interface —** название сетевого интерфейса, на который будет добавлен VIP адрес, если сервер станет мастером.
> - **virtual_router_id —** идентификатор VRRP. Может принимать значение от 1 до 255. Должен быть одинаковым для всех узлов, входящих в кластер.
> - **priority —** приоритет узла. Мастером будет назначен сервер с работающим сервисом и самым высоким приоритетом.
> - **advert_int —** время в секундах, с которой мастер должен сообщать о себе другим нодам. Если за данное время он не успеет отправить широковещательный сигнал, начнутся выборы другого мастера.
> - **preempt_delay —** опция позволяет определить поведение мастера при восстановлении сервиса. Задает время в секундах, после которого сервер с более высоким приоритетом заберет обратно себе роль мастера. Стоит отметить, что при наличии опции **nopreempt** бывшему мастеру не разрешается возвращать свое старое состояние. Опция игнорируется на сервере, где в качестве начального состояния указано **MASTER**.
> - **authentication —** данный блок описывает опции авторизации. Так как запросы широковещательные, очень важно использовать аутентификацию. В данном примере используется пароль 12345678. Должен совпадать с паролем на основном сервере.
> - **virtual_ipaddress —** блок задает VIP.
> - **track_script —** указываем скрипт, с помощью которого будет проверяться работоспособность сервиса.


[Статья](https://www.dmosk.ru/miniinstruktions.php?mini=keepalived-linux)

[Статья](https://selectel.ru/blog/tutorials/what-is-keepalived-and-vip/)

