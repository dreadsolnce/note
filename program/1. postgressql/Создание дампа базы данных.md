## 1. Создание копии базы данных вместе с пользователями (в PostgreSQL они называются "ролями")

> [!NOTE] Информация
> *Стандартная утилита **pg_dump** копирует только одну базу данных, но не трогает роли. Для переноса ролей нужно использовать pg_dumpall.*

### Шаг 1: Экспорт только глобальных объектов (ролей и табличных пространств)

1. ***Выгрузить определения всех пользователей (ролей) и их пароли (в зашифрованном виде).***
```
pg_dumpall --globals-only -U postgres -f roles.sql
```

   * --globals-only: Указывает выгрузить только глобальные объекты, включая роли и табличные пространства, но не данные баз.
   * -U postgres: Подключение от имени суперпользователя postgres. Возможно, у вас другой суперпользователь.
   * -f roles.sql: Сохранение результата в файл roles.sql.

###  Шаг 2: Экспорт схемы и данных конкретной базы данных

> [!NOTE] Информация
> Рекомендуется использовать "custom" формат (-Fc) вместо gzip, так как он более гибкий и устойчивый к ошибкам при восстановлении.
> Рекомендуемый (формат -Fc с внутренним сжатием). Этот дамп уже сжат и не требует gzip

2. ***Создайте дамп самой базы данных.***
```bash
pg_dump -U <имя_пользователя> -d <имя_исходной_бд> -Fc -f db_dump.dump
```

   * -Fc: Создать дамп в сжатом бинарном формате.
   * <имя_пользователя>: Пользователь, имеющий доступ к базе.
   * <имя_исходной_бд>: База данных для копирования.
   * db_dump.dump: Файл с дампом базы.

##### Пример ai-serv2t
```
sudo -u postgres pg_dump -U postgres -d ai -Fc -f /usr/local/share/backupFiles/postgresBackup/dump/ai_$(date "+%Y-%m-%d").dump
```

###  Шаг 3: Восстановление базы данных

 1. ***Восстановите пользователей:***

> [!NOTE] Информация
> Выполните psql для загрузки ролей из файла roles.sql. Это также нужно делать от имени суперпользователя.

```
psql -U postgres -f roles.sql
```

Если вы восстанавливаете на том же сервере, вы увидите ошибки о том, что роли уже существуют — это нормально. Команда создаст только тех пользователей, которых еще нет.

   2. ***Создайте новую базу данных:***


> [!important] Важно
> Важно создать базу данных от имени того пользователя, который будет её владельцем (этот пользователь был восстановлен на предыдущем шаге).
 
```
createdb -U postgres -O <владелец_бд> <имя_новой_бд>
```
* -O <владелец_бд>: Установить владельцем базы указанного пользователя. Используйте то же имя владельца, что и у исходной базы.

   3. ***Восстановите данные в новую базу:***


> [!NOTE] Информация
> Поскольку дамп был создан в формате -Fc, для восстановления используется pg_restore.

```
pg_restore -U postgres -d <имя_новой_бд> db_dump.dump
```
* -d <имя_новой_бд>: Указывает, в какую базу восстанавливать данные.


> [!success] Заключение
> После выполнения этих шагов у вас будет полная копия базы данных, включая всех пользователей, которые имели к ней доступ, с сохранением их прав.

# 2. Пример с ai-db1p

## Файл /usr/local/bin/pgsql_dump.sh

```sh
#!/bin/sh

PATH=/etc:/bin:/sbin:/usr/bin:/usr/sbin:/usr/local/bin:/usr/local/sbin

pathB=<path to nfs disk>
dbUser=<name user db>
database=<name database>

find $pathB \( -name "*-1[^5].*" -o -name "*-[023]?.*" \) -ctime +61 -delete
pg_dump -U $dbUser $database | gzip > $pathB/pgsql_$(date "+%Y-%m-%d").sql.gz
```

***Назад:*** [[program/1. postgressql/!------Содержание------!|!------Содержание------!]]
