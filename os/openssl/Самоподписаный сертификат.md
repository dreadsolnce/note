
> [!NOTE] Для чего нужен
> Для установки подключения к кластеру microk8s, используя его корневой (основной) сертификат.


- **Создаем новый ключ**

```
openssl genrsa -out netology.key 2048
```

- **Создаем запрос на выпуск нового (временного) сертификата.**

> [!NOTE] Title
> На вход передаем ключ из предыдущего шага, а на выходе получаем файл с расширением csr. В subj передается имя пользователя (это самое главное). Из под этого пользователя, мы будем подключаться к кластеру microk8s.

```
openssl req -new -key developer.key -out developer.csr -subj "/CN={ИМЯ ПОЛЬЗОВАТЕЛЯ}"
```

```
openssl req -new -key netology.key -out netology.csr -subj "/CN=netology/O=devops"
```

![[Снимок экрана от 2025-12-18 18-16-21.png]]

- **Подписываем сертификат вышестоящим**


> [!NOTE] Title
> Далее этот сертификат подписывается вышестоящим (т.е. сертификатами кластера microk8s. Таким образом наш сертификат будет как бы в связке с корневым (microk8s) и когда будем подсоединяться к кластеру кластер узнает внутри нашего сертификата свои данные).

Скачиваем с сервера сертификат (корневой) и ключ (если у нас есть к нему доступ)

```
scp ubuntu@89.169.179.153://var/snap/microk8s/current/certs/ca.crt .
```

```
scp ubuntu@89.169.179.153://var/snap/microk8s/current/certs/ca.key .
```

Теперь выпускаем наш новый локальный сертификат с названием netology.crt именно для нашего пользователя netology, с помощью созданного сертификата с расширением csr и скачанного (мастер сертификата, как бы объединяем их) что бы сервер microk8s имел доверие к нам. Можно сказать что мы его подписываем корневыми сертификатами скачанными с сервера.

```
openssl x509 -req -in developer.csr -CA {CA серт вашего кластера} -CAkey {CA ключ вашего кластера} -CAcreateserial -out developer.crt -days 365
```

```
openssl x509 -req -in netology.csr -CA ca.crt -CAkey ca.key -CAcreateserial -out netology.crt -days 500
```

![[Снимок экрана от 2025-12-18 18-27-41.png]]

![[Снимок экрана от 2025-12-18 18-29-06.png]]

- **Таким образом мы получаем основную связку наш сертификат и ключ: netology.crt и netology.key**


> [!NOTE] Title
> Ключ .key — это ваш секретный рукописный подписной образец. Только у вас он есть, и вы используете его, чтобы подписывать документы. Он доказывает, что документ пришел именно от вас. Его нужно хранить в строжайшем секрете.
> Сертификат .crt — это ваше публичное удостоверение личности (как паспорт). В нем указано ваше имя (например, домен сайта example.com), и к нему прикреплен образец вашего публичного ключа (не путать с секретным!). Любой может посмотреть на ваш паспорт, чтобы убедиться, что вы — это вы.

- **Создаем нового пользователя** 

Теперь когда мы создали сертификат мы можем создать нового пользователя кластера kebernetes с привязкой его к сертификату, по которому наш сервер microk8s может его авторизовать, т.к. он может прочитать сертификат клиента.

```
kubectl config set-credentials netology --client-certificate=netology.crt --client-key=netology.key
```

[[os/openssl/!------Содержание------!]]
