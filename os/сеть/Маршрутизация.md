### ***Включение поддержки в ядре Linux пересылки IP-пакетов между сетевыми картами:***

*Временное изменение*
```
sysctl -w net.ipv4.ip_forward=1
```

Постоянное изменение

```
sudo vim /etc/sysctl.conf
```

```
+++ net.ipv4.ip_forward=1
```

```
sudo sysctl -p
```

> [!NOTE] Описание
> Включение `net.ipv4.ip_forward=1` включает **пересылку IP-пакетов** между сетевыми интерфейсами в Linux-системах, что позволяет компьютеру действовать как маршрутизатор. Для временного включения используйте команду `sysctl -w net.ipv4.ip_forward=1`. Для постоянного включения добавьте строку `net.ipv4.ip_forward=1` в файл `/etc/sysctl.conf` (для старых версий Debian) или создайте файл `/etc/sysctl.d/99-ip-forward.conf` с той же строкой (для Debian 13 и новее) и примените изменения командой `sysctl -p` или `sysctl -p /etc/sysctl.d/99-ip-forward.conf` соответственно

### ***Настройка пересылки пакета от сетевой карты (vbox) в созданный туннель:***

```
sudo iptables -A FORWARD -i enp0s8 -o tun0 -j ACCEPT
```

> [!NOTE] Описание
> Цепочка **FORWARD** в iptables предназначена для обработки пакетов, которые проходят через Linux-машину, но не предназначены для неё самой, а должны быть перенаправлены дальше на другие хосты. Эта цепочка используется, когда компьютер выполняет роль маршрутизатора или шлюза между разными сетями.
> **Назначение:** Пакеты, поступающие в цепочку **FORWARD**, не являются "входящими" (INPUT) для самого сервера и не "исходящими" (OUTPUT) с него. Они предназначены для другого компьютера, находящегося за этим маршрутизатором.


```
sudo iptables -t nat -A POSTROUTING -o tun0 -j MASQUERADE
```

> [!NOTE] Описание
> **NAT (преобразование сетевых адресов) с преобразованием порта является разновидностью маскирующего NAT**. NAT с преобразованием порта позволяет скрыть не только IP-адрес, но и номер порта. Это позволяет обрабатывать пакеты, которые поступают как от внутренних компьютеров, так и от внешних систем.

 ```
 sudo iptables -L --line-numbers
 ```

### ***Сохранение маршрутов после перезагрузки:***

*Сохранение настроек в файл*
```
sudo iptables-save -f /etc/iptables-conf/iptables_rules.ipv4
```

*Применение настроек из файла при загрузке*
```
sudo vi /etc/network/if-pre-up.d/iptables
```

```
+++ #!/bin/sh	
+++ /sbin/iptables-restore < /etc/iptables-conf/iptables_rules.ipv4 
```

*Добавление атрибута на исполнение*
```
sudo chmod +x /etc/network/if-pre-up.d/iptables
```

***Назад:*** [[os/сеть/!------Содержание------!]]