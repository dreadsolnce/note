#### packer

***Проверка файла конфигурации:***

```
packer validate mydebian.json
```

***Создание образа:***
```
packer build mydebian.json
```

#### docker и docker compose

***Базовые команды Docker***

*Загрузить образ из Docker-реестра на Docker-хост:*

```
docker pull hello-world 

docker pull kolchinvladimir/custom-nginx:1.0.0
```

*Просмотр скачанных в системе образов:*

```
docker image ls

docker images
```

*Запуск docker контейнера:*

```
docker run hello-world
```

*Запуск docker контейнера в фоновом режиме:*

```
docker run -d nginx
```

*Запуск docker-контейнера в интерактивном режиме (войти в оболочку bash - при выходе из bash контейнер остановится т.к. ключа -d):*

```
docker run -it ubuntu bash
```

*Запуск docker контейнера из образа и подключение к нему с удалением контейнера после остановки (при выходе из bash контейнер остановится т.к. ключа -d):*

```
docker run -it -rm --name nginx kolchinvladimir/custom-nginx:1.0.6 bash
```

*Запуск docker контейнера из образа, в фоновом режиме (при выходе из интерактивного режима контейнер продолжает работать), с заданием ему имени, со связыванием портов, и  удалением контейнера после остановки*\

```
docker run -d --name nginx --rm -p 8888:80 image-nginx:1.0.0
```

*Запуск команды в запущенном контейнере:*

```
docker exec nginx ls

docker exec nginx nginx -v
```

*Подключение к запущенному контейнеру:*

```
docker exec -it nginx bash
```

*Удаление контейнера*:

```
docker rm nginx
```

*Удалить запущенный контейнер:*

```
docker rm -f nginx
```

*Удаление всех образов в том числе и запущенных:*

```
docker rm -f $(socker ps -a -q)
```

*Удаление образа:*

```
docker rmi kolchinvladimir/custom-nginx:1.0.6
```

*Удаление неиспользуемых объектов:*

```
docker system prune
```

*Сборка образа из докер файла:*

```
docker build -t image-nginx:1.0.0 .
```

*Авторизация (подключение) к docker hub:*

```
docker login -u <login in dockerhub>
```

*Загрузка существующего образа на docker hub:*

> [!NOTE] Замечание
> Для загрузки образа на docker hub его необходимо собрать именем в формате: \<login in dockerhub>/<название папки на сервере >

```
docker build -t kolchinvladimir/custom-nginx:2.0.0 .
```

*Загрузить образ на сервер docker hub:*

```
docker image push kolchinvladimir/custom-nginx:2.0.0
```

*Переименование запущенного контейнера:*

```
docker rename mynginx newnginx
``` 

*Просмотр истории (слое) образа:*

```
docker history nginx:2:0.0
```

*Подключение к стандартному потоку ввода/вывода/ошибок контейнера:*

```
docker attach newnginx
```

> [!NOTE] Важно
> ***При нажатии клавиши Ctrl + С контейнер будет остановлен***
> Для правильного отключения от потока необходимо выполнить (только если контейнер был запущен с параметром  -it):
>   - отключение от потока: Ctrl + p
>   - затем нажать: Ctrl + q

*Настройка удалённого контекста:*

```
docker context create remote-ssh --docker host=ssh://<user>@<remote_host>
```

*Просмотр настроенных контекстов:*

```
docker context ls
```

*Переключиться на нужный контекст:*

```
docker context use remote-ssh
```

***Базовые команды Docker Compose***

*Извлекает/Собирает/Запускает контейнеры на основе указанных в **service** образов в фоновом режиме:*

```
docker-compose up -d
```

*Перезагрузка контейнеров:*

```
docker compose restart
```

*Остановка и удаление контейнеров на основе указанных в **service** образов в docker-compose файле:*

```
docker compose down
```

*Запуск с указанием файла запуска:*

```
docker compose -d -f /opt/app/compose.yaml up
```


**docker-compose build** — Cборка образа. Собранные образы помечаются, как _projectservice_.
**docker-compose pull** — Скачивает образы из удалённого реестра в локальный _Docker Registry_.
**docker-compose push** — Загружает образ из локально реестра в удаленный реестр (_Docker Registry_).  
  
**docker-compose logs (-f)** — Выводит в STDOUT логи контейнеров на основе указанных в _stanza service_: запущенных контейнеров.  
**docker-compose ps (-a)** — Выводит список запущенных контейнеров на основе указанных в _stanza service_: в _docker-compose_ файле.  
**docker-compose top** — Выводит список запущенных процессов внутри контейнеров на основе указанных в _stanza service_: в _docker-compose_ файле.  


####  docker swarm

*Добавление роли manager*

```
docker node promote <node name>
```

*Удаление роли manager*  

```
docker node demote <node name>
```

Просмотр токена для подключения воркера в кластер

```
docker swarm join-token -q worker
```

Просмотр токена для подключения manager-а в кластер

```
docker swarm join-token -q manager
```

Просмотр состояния кластера:

```
docker node ls
```


#### yс


Просмотр общей конфигурации:

```
yc config list
```

Просмотр созданных реестров для docker образов:

```
yc container registry list
```

Посмотреть список образов в облаке:

```
yc compute image list
```

Посмотреть список vm в облаке:

```
yc compute instance list
```

Остановить vm

```
yc compute instance stop <name>
```

Запустить vm

```
yc compute instance start <name>
```

Перезапустить vm

```
yc compute instance restart <name>
```

Удалить vm

```
yc compute instance delete <name>
```

Посмотреть список сетей

```
yc vpc network list
```

Изменить имя сети:

```
yc vpc network update net --new-name my-net
```

Посмотреть список под сетей

```
yc vpc subnet list
```

Список дисков

```
yc compute disk list
```

Удалить диск

```
yc compute disk delete disk-1754483572278
```

Список подготовленных образов\

```
yc compute image list
```

Удалить образ

```
yc compute image delete  debian-11-docker
```


##### Создание IAM tokena

yc iam create-token

export TF_VAR_yc_token="t1.9euelZqWxsqVi5WVmsuKxpPIjY_Ine3rnpWajIqSiceLnovMj5KRiciXzprl8_dRbD86-e8GOEJN_t3z9xEbPTr57wY4Qk3-zef1656VmpaXi46OkZLNyZfKjcaRx5nG7_zF656VmpaXi46OkZLNyZfKjcaRx5nG.ObpoEo8pgE6X2Pn3tBVV1XYOBBRs2n1EWEuBFtQTqsJv0EpNNDpt_ZNVXkZM9H20WGVKCemi8TxFAQCHbtaYCg"

vim ~/.bashrc

source ~/.bashrc

providers.tf
```
provider "yandex" {  
    
  # token     = var.token  
  # service_account_key_file = file("~/keys/authorized_key.json")  # токен берется из переменной окружения TF_VAR_YC_TOKEN  token = var.yc_token  
  cloud_id  = var.cloud_id  
  folder_id = var.folder_id  
}
```

variables.tf
```
variable "yc_token" {  
  description = "IAM token for Yandex Cloud authentication"  
  type        = string  
  default     = ""  
}

#### ansible

ansible -m ping                                         # Сделаем ping на locahost

ansible -m ping -i inventory.yml all                    # Сделаем ping на всех хостах из inventory

ansible -m ping -i inventory.yml <group_name>           # Сделаем ping на всех хостах группы <group_name>

ansible-playbook site.yml -i inventory/test.yml         # Запуск site на хостах из test

ansible-inventory -i inventory.yml --graph <group_name> # Показать хосты группы

ansible-inventory -i inventory.yml --list               # Показать все переменные всех хостов из inventory

ansible-inventory -i inventory.yml --list \<hostname>    # Показать все переменные хоста из inventory

ansible-doc <plugin_name>                               # Показать документацию по плагину 

ansible-vault create \<filename>                         # Создать новый зашифрованный файл

ansible-vault edit \<filename>                           # Отредактировать зашифрованный файл

ansible-vault view \<filename>                           # Просмотреть зашифрованный файл

ansible-vault rekey \<filename>                          # Поменять пароль у файла

ansible-vault decrypt \<filename>                        # Расшифровать файл

*Проверка playbook без применения настроек:*

`ansible-playbook -i inventory/prod.yml site.yml --check`

*Старт (начало) выполнения playbook-а с определенной точки:*

`ansible-playbook -i inventory/prod.yml site.yml --start-at-task=`

*Запуск playbook-а в интерактивном режиме (будет спрашивать подтверждение выполнения каждой таски):*

`ansible-playbook -i inventory/prod.yml site.yml --step`

*Запуск playbook-а  с выводом дополнительной диагностической информаций (всего 6 уровней {букв v}):*

`ansible-playbook -i inventory/prod.yml site.yml -v`

*Запуск playbook-a по тегу:*

`ansible-playbook -i inventory/prod.yml site.yml --tags "tag1,tag2,tag3" `

*Запуск playbook-а с выводом какие изменения в файлах происходят (аналог diff в github-е). Полезно использовать с ключом check:*

`ansible-playbook -i inventory/prod.yml site.yml --diff --check`

*Запуск playbook-а в пошаговом режиме с запросом пароля sudo:*

`ansible-playbook -i inventory/prod.yml site.yml --step --ask-become-pass`

Запуск playbook-а для определенной группы:

`ansible-playbook -l dev -i inventory/prod.yml site.yml --diff --check`

## molecule

Добавление сценариев тестирования molecul-ой в существующую роль
```
molecule init scenario -d docker
```

Запуск полного сценария тестирования:
```
molecule test
```








