
### Задача 0

```
docker-compose --version
```

![[Снимок экрана от 2025-08-14 10-31-45.png]]

```
docker compose version
```

![[Снимок экрана от 2025-08-14 10-32-15.png]]

### Задача 1

```
https://github.com/netology-code/shvirtd-example-python
```

`Fork -> Стрелака вниз -> Create a new fork -> Create fork`

```
mkdir dz4
```

```
cd dz4
```

```
git clone git@github.com:dreadsolnce/shvirtd-example-python.git
```

```
cd shvirtd-example-python
```

```
cp Dockerfile Dockerfile.python
```

```
vim Dockerfile.python
``` 

![[Снимок экрана от 2025-08-14 11-35-42.png]]

```
vim .dockerignore
```

![[Снимок экрана от 2025-08-18 10-39-22.png]]

```
docker build -f ./Dockerfile.python -t app:1.0.0 .
```

```
docker run -d --rm -p 127.0.0.1:5000:5000 --name app app:1.0.0
```

```
docker stop
```

Локальный запуск:

```
cd .. ; mkdir local 
```

```
cd local
```

```
vim run.sh
```

`
```
#!/bin/bash
# Создайте виртуальное окружение
python3 -m venv venv
source venv/bin/activate  # в Windows: venv\Scripts\activate

# Установите зависимости
pip install -r requirements.txt


# Настройте переменные окружения для подключения к БД(не забудьте отдельно запустить БД)

#export DB_HOST='127.0.0.1'
#export DB_USER='app'
#export DB_PASSWORD='very_strong'
#export DB_NAME='example'

# Запустите приложение
uvicorn main:app --host 0.0.0.0 --port 5000 --reload

```

```
chmod +x run.sh
```

```
cp ../shvirtd-example-python/requirements.txt .
```

```
cp ../shvirtd-example-python/main.py .
```

```
export DB_HOST='127.0.0.1'
export DB_USER='app'
export DB_PASSWORD='very_strong'
export DB_NAME='example'
```

```
docker run --rm --name some-mysql -e MYSQL_DATABASE=${DB_NAME} -e MYSQL_USER=${DB_USER} -e MYSQL_PASSWORD=${DB_PASSWORD} -e DB_HOST=${DB_HOST} -e MYSQL_ROOT_PASSWORD=${DB_PASSWORD} -p 3306:3306 -d mysql:latest
```

```
docker ps
```

Закоментировать переменные окружения:

![[Снимок экрана от 2025-08-14 12-34-22.png]]

==Исправить строку определения переменной db_name в файле main.py:==

![[Снимок экрана от 2025-08-14 12-36-05.png]]

```
./run.sh
```

Проверка подключения к базе данных:

```
docker exec -it some-mysql bash
```

```
mysql -p
```

```
exit
```

```
exit
```

```
docker stop some-mysql
```

### Задача 2

https://console.yandex.cloud -> cloud-kolchinvladimir83 -> Создать каталог (название тест)

Создайте реестр в Container Registry:

```
yc container registry create --name test
```

Аутентифицируйтесь в Container Registry с помощью [Docker Credential helper](https://yandex.cloud/ru/docs/container-registry/operations/authentication#cred-helper):
 
 Сконфигурируйте [Docker](https://yandex.cloud/ru/blog/posts/2022/03/docker-containers) для использования `docker-credential-yc`

```
yc container registry configure-docker
```

Проверка:

```
cat /home/kvl/.docker/config.json | grep cr.yandex
```

```
docker pull ubuntu
```

```
docker tag ubuntu cr.yandex/crp3s9nu72tqtpcgdhub/ubuntu:1.0.0
```
где номер - это id из вывода команды yc container registry configure-docker (not folder id)


```
docker push cr.yandex/crp3s9nu72tqtpcgdhub/ubuntu:1.0.0
```
где номер - это id из вывода команды yc container registry configure-docker (not folder id)

```
docker run -it --rm cr.yandex/crp3s9nu72tqtpcgdhub/ubuntu:1.0.0 bash
```

*просмотр образов в container registry*

```
yc container image list
```

*удалить образ из контейнера*

```
 yc container image delete crp1b4am02bdecq429oc
```

```
cd ../shvirtd-example-python/
```


```
docker build -f ./Dockerfile.python -t app:1.0.0 .
```

```
docker tag app:1.0.0 cr.yandex/crp3s9nu72tqtpcgdhub/app:1.0.0
```

```
docker push cr.yandex/crp3s9nu72tqtpcgdhub/app:1.0.0
```

default -> Container Registry -> Реестры -> my-first-registry -> app -> ... Сканировать

### Задача 3

```
vim compose.yaml
```

```
include:
  - proxy.yaml
services:
  web:
    image: cr.yandex/crpamnfpng0opihqtj7g/app:1.0.0
    container_name: app
    hostname: app
    environment:
      - DB_HOST=db
      - DB_USER=${MYSQL_USER}
      - DB_PASSWORD=${MYSQL_PASSWORD}
      - DB_NAME=${MYSQL_DATABASE}
    ports:
      - "5000:5000"
    restart: on-failure
    depends_on:
      - db
    networks:
      backend:
        ipv4_address: 172.20.0.5

  db:
    image: mysql:8.0
    container_name: mysql
    hostname: mysql
    environment:
      - MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD}
      - MYSQL_USER=${MYSQL_USER}
      - MYSQL_PASSWORD=${MYSQL_PASSWORD}
      - MYSQL_DATABASE=${MYSQL_DATABASE}
    command: --default-authentication-plugin=caching_sha2_password
    ports:
      - "3306:3306"
    volumes:
      - volume_db:/var/lib/mysql
    restart: on-failure
    networks:
      backend:
        ipv4_address: 172.20.0.10

volumes:
  volume_db:

```

Запуск compose.yaml:

*Первый запуск:*
```
docker compose up -d && docker restart app
```

*Дальше можно запускать:*

```
docker compose up -d
```


> [!NOTE] Пояснение
> Это связано с тем что при первом запуске инициализируется база данных, и внутри контейнера база данных останавливается и снова запускается.
> При этом служба app стартует после того как db первый раз отстановился, но так как база даннных не до конца проинициализировалась, то 
> служба app не выдает нужный результат. Ее необходимо еще раз рестартануть. Решение: прописать volume, то ошибка будет возникать только при первом 
> запуске.


### Задача 4

```
cd packer/src
```

```
packer build myubuntu.json 
```

Создаем в yandex cloud виртуальную машину:
```
https://console.yandex.cloud/folders/b1gdmpusv51ippn2psip/compute/instances
```

```
ssh -l ubuntu 158.160.39.66
```

Аутентифицируемся на yandex cloud по токену oauth для скачивания из registry образа:

```
docker login --username oauth cr.yandex
```

вместо пароля подставляем наш токен:

```
Password: y0__xD-ppOVARjB3............
```

```
vim run.sh
```

```
#/bin/bash

sudo mkdir /opt/project

sudo chown -R ${whoami}:$(whoami) /opt/project

git clone https://github.com/dreadsolnce/shvirtd-example-python.git /opt/project

docker compose -f /opt/project/compose.yaml up -d

```

```
chmod +x run.sh
```

```
sudo ./run.sh
```

*Проверка:*

https://check-host.net/check-http

`http://158.160.39.66:8090`

На хостовой машине настроить контекст:

```
docker context create remote-ssh --docker host=ssh://<user>@<remote_host>
```

```
docker context ls
```

```
docker context use remote-ssh
```

```
docker ps -a
```

```
curl -L http://127.0.0.1:8090
```

```
curl -L http://158.160.39.66:8090
```

### Задача 5

Замечание: по умолчанию образ schnitzler/mysqldump выдает ошибку: 
mysqldump: Got error: 1045: "Plugin caching_sha2_password could not be loaded: Error loading shared library /usr/lib/mariadb/plugin/caching_sha2_password.so: No such file or directory" when trying to connect

Поэтому данный образ необходимо доработать:

```
vim Dockerfile
```

```
FROM schnitzler/mysqldump:3.17

RUN apk update

RUN apk add mariadb-connector-c
```

```
docker build -t my-mysqldump .
```

Команда запуска (для проверки):

```
docker run --rm --entrypoint "" -v /opt/backup:/backup --link=mysql:alias --network=project_backend my-mysqldump mysqldump --opt -h alias -u root -p"YtReWq4321" "--result-file=/backup/dumps.sql" virtd
```

Скрипт резервного копирования базы данных:
```
vim /opt/project/backup.sh
```

```
#!/bin/bash


MYSQL_ROOT_PASSWORD=$(cat /opt/app/.env | grep MYSQL_ROOT_PASSWORD | awk -F= '{print $2}')
MYSQL_DATABASE=$(cat /opt/app/.env | grep  MYSQL_DATABASE| awk -F= '{print $2}')

docker run --rm --env-file /opt/app/.env  --entrypoint "" -v /opt/backup:/backup --link=db:alias --network=app_backend my-mysqldump:latest mysqldump --opt -h alias -u root -p"${MYSQL_ROOT_PASSWORD}" "--result-file=/backup/dumps.sql_$(date +%F_%T)" ${MYSQL_DATABASE}
```

Добавляем в задание cron каждую минуту:

```
crontab -e
```

```
*/1 * * * * /opt/project/backup.sh
```

### Задача 6
Новое решение:

```
DIVE_VERSION=$(curl -sL "https://api.github.com/repos/wagoodman/dive/releases/latest" | grep '"tag_name":' | sed -E 's/.*"v([^"]+)".*/\1/')
curl -fOL "https://github.com/wagoodman/dive/releases/download/v${DIVE_VERSION}/dive_${DIVE_VERSION}_linux_amd64.deb"
sudo apt install ./dive_${DIVE_VERSION}_linux_amd64.deb
```

```
docker pull hashicorp/terraform:latest
```

```
dive hashicorp/terraform:latest
```
> Выделить слой с копированием файла terraform
> Запомнить id Digest и путь куда копируется файл terrafaorm


```
docker save hashicorp/terraform:latest -o image.tar
```

```
mkdir image
```

```
tar -xvf image.tar -C image/
```

```
cd image
```

```
tar -xf blobs/sha256/6be188821a1e6d0af92854aa290cf75a053ad8525dfc35f3d7d256daeb20bc34
```

```
cp /bin/terraform ~
```


Старое решение:
```
docker pull hashicorp/terraform:latest
```

```
docker save hashicorp/terraform:latest -o my-image.tar
```

```
tar -xvf my-image.tar
```

```
docker images 
```

```
docker image inspect c1599db6ecf1
```

```
sudo find /var/lib/docker/overlay2/c3d0132b402a329985edad653eca1b896dcba9d6c8554ad8e77f129bd0bbe79e/diff -name terraform
```

```
sudo cp /var/lib/docker/overlay2/c3d0132b402a329985edad653eca1b896dcba9d6c8554ad8e77f129bd0bbe79e/diff/bin/terraform ~
```

scp ...

### Задача 6.1

```
docker pull hashicorp/terraform:latest
```

```
docker run -it hashicorp/terraform:latest version
```

```
docker ps -a
```

```
docker cp 5ea67075eede:/bin/terraform .
```

```
scp ...
```

### Задача 6.2

Создать Dockerfile:

```
vim Dockerfile
```

```
FROM ubuntu:22.04

VOLUME ["/bin"]
```

Собрать образ:

```
docker build -t myimage:4.0 .
```

Запустить контейнер:

```
docker run -d myimage:4.0
```

Посмотреть volum:

```
docker volume ls
```

Скопировать volume name

Найти данный volume:

```
sudo find /var/lib/docker/ -name f43b50dd1398bc62a44a62371d76fe73d34cd042ae5b82665cae57b4c0b755e0
```

```
sudo ls -al /var/lib/docker/volumes/f43b50dd1398bc62a44a62371d76fe73d34cd042ae5b82665cae57b4c0b755e0

```

```
sudo ls -al /var/lib/docker/volumes/f43b50dd1398bc62a44a62371d76fe73d34cd042ae5b82665cae57b4c0b755e0/_data
```

```
cp /var/lib/docker/volumes/f43b50dd1398bc62a44a62371d76fe73d34cd042ae5b82665cae57b4c0b755e0/_data/df .
```

### Задача 7

```
mkdir testcontainer
```

```
cd testcontainer/
```

```
mkdir rootfs
```

```
docker export $(docker create python:3-alpine) | tar -C rootfs -xvf -
```

```
sudo runc spec
```

```
vim app.py
```

```
print("Hello, World!")
```

```
python3 app.py
```

```
sudo vim config.json
```

![[Снимок экрана от 2025-08-19 11-27-44.png]]

```
sudo cp app.py rootfs/bin/app.py
```

```
sudo runc run testcontainer
```





